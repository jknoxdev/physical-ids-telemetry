@startuml sequence
!pragma layout smetana

skinparam {
    BackgroundColor #1a1a2e
    SequenceArrowColor #7EC8E3
    SequenceArrowFontColor #CCCCCC
    SequenceArrowFontSize 10
    SequenceBoxBackgroundColor #0f3460
    SequenceBoxBorderColor #FF6B35
    SequenceBoxFontColor #FF6B35
    SequenceBoxFontSize 12
    SequenceGroupBackgroundColor #0D2818
    SequenceGroupBorderColor #27AE60
    SequenceGroupFontColor #27AE60
    SequenceGroupFontSize 11
    SequenceGroupBodyBackgroundColor #0a1a10
    SequenceDividerBackgroundColor #1a1a2e
    SequenceDividerBorderColor #4A90D9
    SequenceDividerFontColor #4A90D9
    SequenceLifeLineBorderColor #4A90D9
    SequenceLifeLineBackgroundColor #0f3460
    ParticipantBackgroundColor #0f3460
    ParticipantBorderColor #4A90D9
    ParticipantFontColor #FFFFFF
    ParticipantFontSize 12
    ActorBackgroundColor #0f3460
    ActorBorderColor #7EC8E3
    ActorFontColor #FFFFFF
    NoteBackgroundColor #0D2818
    NoteBorderColor #27AE60
    NoteFontColor #AAAAAA
    NoteFontSize 10
    DatabaseBackgroundColor #2C0E3F
    DatabaseBorderColor #9B59B6
    DatabaseFontColor #FFFFFF
}

title <size:18><color:#7EC8E3><b>L.I.M.A. — Integrity Event Sequence</b></color></size>\n<size:12><color:#888888>Single event: sensor trigger → operator notification</color></size>

participant "BMP280\nBarometric" as baro #0f3460
participant "MPU6050\nIMU" as imu #0f3460
participant "Event\nAggregator" as agg #1a3060
participant "CryptoCell-310\nSigner" as crypto #2a1a4a
participant "BLE 5.0\nStack" as ble #0f3460
participant "BLE\nScanner" as scanner #0f3460
participant "MQTT\nPublisher" as mqtt_pub #0f3460
participant "Mosquitto\nBroker" as mosquitto #1a3060
participant "Event\nRouter" as router #1a3060
participant "Signature\nVerifier" as verifier #2a1a4a
database "SQLite\nAudit Log" as sqlite #2C0E3F
participant "Queue\nManager" as queue #1a3060
participant "Push\nNotifier" as push #0f3460
actor "Security\nOperator" as operator

== Sensor Polling [continuous / low-power] ==

baro -> agg : pressure sample\n[every 500ms]
imu -> agg : accel/gyro sample\n[every 100ms]

note right of agg
  <color:#27AE60>Each sensor monitored
  independently — either
  alone is sufficient to
  trigger an integrity event</color>
end note

== Independent Trigger Paths ==

alt BARO TRIGGER — Enclosure/Pressure Breach
    baro -> agg : <color:#FF6B35>PRESSURE DELTA > threshold</color>
    activate agg
    note right of baro
      <color:#27AE60>Use case: cabinet puncture,
      enclosure breach, door seal
      broken — node stationary</color>
    end note
    agg -> agg : compose event\n[type: PRESSURE_BREACH\ntimestamp, node_id, delta_pa]

else IMU TRIGGER — Physical Movement/Tow
    imu -> agg : <color:#FF6B35>MOTION DETECTED > threshold</color>
    activate agg
    note right of imu
      <color:#27AE60>Use case: vehicle tow,
      rack movement, vibration
      attack — pressure stable</color>
    end note
    agg -> agg : compose event\n[type: MOTION_DETECTED\ntimestamp, node_id, accel_g]

else DUAL TRIGGER — Full Physical Intrusion
    baro -> agg : <color:#FF6B35>PRESSURE DELTA > threshold</color>
    imu -> agg : <color:#FF6B35>MOTION DETECTED > threshold</color>
    activate agg
    note right of agg
      <color:#27AE60>Use case: door opened
      and enclosure moved —
      hardest to defeat, attacker
      must suppress both sensors</color>
    end note
    agg -> agg : compose event\n[type: DUAL_BREACH\ntimestamp, node_id, all_sensors]
end

== Signing [common path] ==

agg -> crypto : integrity event payload
activate crypto
crypto -> crypto : generate nonce
crypto -> crypto : ECDSA-P256 sign\n[hardware accelerated]
crypto -> ble : signed + encrypted payload
deactivate crypto
deactivate agg

note right of crypto
  <color:#27AE60>CryptoCell-310
  ~50ms signing time
  per-event nonce
  prevents replay</color>
end note

== BLE Transmission ==

ble -> scanner : BLE 5.0 Coded PHY\nadvertisement
activate scanner
scanner -> mqtt_pub : raw BLE payload
deactivate scanner
mqtt_pub -> mosquitto : MQTT publish\ntopic: lima/events/[node_id]

== Gateway Processing ==

mosquitto -> router : deliver message\n[subscribe: lima/#]
activate router
router -> verifier : event payload + signature
activate verifier

== Verification Branch ==

alt Signature VALID
    verifier -> sqlite : <color:#9B59B6>INSERT event\n[status: VERIFIED, type: event_type]</color>
    verifier -> queue : enqueue for egress
    deactivate verifier
    deactivate router

    == Egress: Queue Flush ==

    alt Internet AVAILABLE
        queue -> push : POST alert\n[HTTPS / API]
        push -> operator : <color:#7EC8E3>push notification\n"[event_type] detected on [node_id]"</color>
    else Internet UNAVAILABLE
        queue -> sqlite : <color:#9B59B6>UPDATE status: QUEUED\n[flush on reconnect]</color>
        note right of queue
          <color:#27AE60>SQLite always written
          first — audit trail
          intact regardless of
          connectivity</color>
        end note
    end

else Signature INVALID
    verifier -> sqlite : <color:#FF6B35>INSERT event\n[status: TAMPERED]</color>
    verifier -> queue : enqueue SECURITY ALERT
    deactivate verifier
    deactivate router
    queue -> push : POST security alert\n[HTTPS / API]
    push -> operator : <color:#FF6B35>push notification\n"TAMPERED EVENT DETECTED"</color>
    note right of verifier
      <color:#FF6B35>Verification failure
      is itself a security
      event — logged + alerted
      immediately</color>
    end note
end

== Operator Acknowledges ==

operator -> operator : reviews event\nin dashboard / app

@enduml
